<!DOCTYPE html>

<html>


<head>
	<title>California FitnessGram Map</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<!--
	JOHN: You don't need to include the json here, it is loaded asynchronously using d3.json
	<script src="CA_county.json"></script>
	-->

	<script type="text/javascript" src="http://use.typekit.com/brf5jpj.js"></script>
	<script src="//use.typekit.net/drk2sev.js"></script>

	<style type="text/css" src="fitness_ca.css"></style>

</head>

<body>

	<!-- Add page elements here -->

	<!-- John: the h1 shouldn't go inside the div -->
	<h1> FitnessGram Data </h1>
	<div id="map">


	</div>

	<div id="zoom" class="hidden">
		<p>County: <span id="county">County Name</span></p>
	</div>


	<script type="text/javascript">

		// Width and height 
		var width = 850
		var height = 1100

		// Define map projection on CA
		var CAprojection = d3.geoAlbers()
			.center([ -22, 40 ]) 	// sets the latitude
			.scale( 1300*width/200) //scale down to see entire CA
			.rotate([106,3,10.5]);	// longitude, latitude, roll

		//Define path generator
		var path = d3.geoPath()		//path generator converts GeoJSON to SVG path
			.projection(CAprojection); 		// tells path generator to use geoAlbers



		// Create SVG element
		var svg = d3.select("#map")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

		var tooltip = d3.select('#map').append('div')
			.attr('class', 'hidden tooltip');

		var color_by = "Fitness";

		var color = d3.scaleLog()
			  .range(["aqua", "midnightblue"]);


		// Load in FitnessGram data
		
	
		// "g" contains geometry elements
		var g = svg.append("g");

		//Load map data
		// d3.json("CA_county.json", function(err,json) {
		// 	if (err) throw err;
		// 	var caFeatures = json.features.filter(function (d) {
		// 		return d.properties.STATEFP==="06"; // The fips code of california
		// 	})
		// 	console.log(json);
		// 	g.selectAll("path")
		// 		.data(caFeatures)
		// 		.enter()
		// 		.append("path")
		// 		.attr("fill", "pink")
		// 		.attr("stroke", "#333")
		// 		.attr("d", path);
		// });




		// NEW CODE STARTS HERE
		d3.csv("Test.csv", function(data) {
			console.log(data);
			data.forEach(function(d) {
				// d["County_num"] = +d["Num"]
				d["County"] = +d["County"];
				d["Fitness"] = +d["Fitness"];
			});
		  

		color.domain([d3.min(data, function(d) {
			return d[color_by] || Infinity;; 
			}), d3.max(data, function(d) { 
				return d[color_by]; 
			})]); // setting the range of the input data
  
		// Load GeoJSON data
		d3.json("CA_county.json", function(err,json) {
			if (err) throw err;
			var caFeatures = json.features.filter(function (d) {
				return d.properties.STATEFP==="06"; // The fips code of california
			})
			console.log(json);
			// g.selectAll("path")
			// 	.data(caFeatures)
			// 	.enter()
			// 	.append("path")
			// 	.attr("fill", "purple")
			// 	.attr("stroke", "#333")
			// 	.attr("d", path);

			// Loop through each county's data value in the .csv file
			for (var i = 0; i < data.length; i++) {
  			//console.log("i", i, data[i][color_by]);

				// Grab County Name
				var dataCounty = data[i].County;
  				var dataFitness = data[i][color_by];

				// Find the corresponding county inside the GeoJSON
				for (var j = 0; j < caFeatures.length; j++)  {
					var jsonCounty = caFeatures[j].properties.COUNTYFP;
   			 		//console.log(jsonState);

					if (dataCounty == jsonCounty) {

						// Copy the data value into the JSON
						caFeatures[j].properties.cases = dataFitness;
      					//console.log(jsonState,json.features[j].properties.cases);

						// Stop looking through the JSON
						break;
					}
				}
			}
		
			// Bind the data to the SVG and create one path per GeoJSON feature
			svg.selectAll("path")
				.data(caFeatures)
				.enter()
				.append("path")
				.attr("d", path)
				.style("stroke", "#353535")
				.style("stroke-width", ".5")
				.style("fill", function(d) {

				// Get data value
				var value = d.properties.cases;

				if (value && color(value)) {
					return color(value);
				} else {
					return "white";
				}
			})

			.on('mousemove', function(d) {
			  console.log(d);
			                    var mouse = d3.mouse(svg.node()).map(function(d) {
			                        return parseInt(d);
			                    });
			                    tooltip.classed('hidden', false)
			                        .attr('style', 'left:' + (mouse[0] + 15) +
			                                'px; top:' + (mouse[1] + 50) + 'px')
			                        .html(d.properties.name + ": " + d.properties.cases);
			                })
			                .on('mouseout', function() {
			                    tooltip.classed('hidden', true);
			                });;
 
		});
}); 
	

// 		//Load in counties from json file with the mouseover feature to show county name
// 		d3.json("CA_county.json", function(json) {
// 				console.log(json);
// 				//Bind data and create one path per GeoJSON feature
// 				svg.selectAll("path")
// 					.data(json.features)
// 					.enter()
// 					.append("path")
// 					.attr("d", path)
// 				   	.on("mouseover", function(d){
// 						var xPosition = width/2 + 150;
// 						var yPosition = height/2;
// // 						var xPosition = parseFloat(path.centroid(this).attr("cx"));
// // 						var yPosition = parseFloat(path.centroid(this).attr("cy"));
// 						d3.select("#tooltip")
// 						.style("left", xPosition + "px")
// 						.style("top", yPosition + "px");
// 						d3.select("#county")
// 						.text(d.properties.NAME);
// 						d3.select("#tooltip")
// 						.classed("hidden", false);
// 						})
// 						.on("mouseout", function(){
// 						d3.select("#tooltip").classed("hidden", true);
// 						});

// 			});

	</script>

</body>

</html>
